---
- name: Deploy Flask App to Azure VMs
  hosts: webservers
  become: yes

  vars:
    project_dir: /repo
    repo_url: https://github.com/Buschhen/CC2.git
    venv_dir: /repo/venv

  tasks:
    - name: Install required apt packages
      apt:
        name: [git, python3-pip, python3-venv, tree]
        state: present
        update_cache: yes

    # - name: Generate hierarchical directory visualization
    #   command: tree ./
    #   register: tree_structure
    #   ignore_errors: true

    # - name: Present directory structure for diagnostic examination
    #   debug:
    #     var: tree_structure.stdout

    # - name: Retrieve file metadata on target machine
    #   stat:
    #     path: "{{ secrets_file }}"
    #   register: file_status

    # - name: Display file properties for debugging purposes
    #   debug:
    #     msg: >
    #       Existence verification: {{ file_status.stat.exists }}.
    #       Detailed attributes: {{ file_status.stat }}

    # - name: Import concealed parameters from JSON artifact
    #   set_fact:
    #     credentials: "{{ lookup('file', '../secrets.json') | from_json }}"
    # - name: Exhibit extracted secure elements (illustrative)
    #   debug:
    #     msg: "storage_container_name: {{ credentials.storage_container_name }}"

    - name: ğŸ” DEBUG - Show current hostname
      command: hostname
      register: hostname_output

    - name: ğŸ” DEBUG - Print hostname
      debug:
        msg: "Running on host: {{ hostname_output.stdout }}"

    - name: Clone project repo
      git:
        repo: "{{ repo_url }}"
        dest: "{{ project_dir }}"
        version: master
        force: yes

    - name: Create Python virtual environment
      command: python3 -m venv "{{ venv_dir }}"
      args:
        creates: "{{ venv_dir }}"

    - name: Install Python requirements
      pip:
        requirements: "{{ project_dir }}/requirements.txt"
        virtualenv: "{{ venv_dir }}"

    - name: Copy .env to VM
      copy:
        src: .env
        dest: "{{ project_dir }}/app/.env"
        owner: azureuser
        group: azureuser
        mode: "0600"

    - name: Copy systemd service file for Flask
      template:
        src: flask.service.j2
        dest: /etc/systemd/system/flask.service
        mode: '0644'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Flask app service
      systemd:
        name: flask
        state: restarted
        enabled: yes

    - name: ğŸ” Show Flask service status
      shell: systemctl status flask --no-pager
      register: flask_status
      changed_when: false

    - name: ğŸ” Print Flask service status
      debug:
        var: flask_status.stdout_lines

    - name: ğŸ” DEBUG - Show running Python processes
      shell: pgrep -fl python
      register: python_procs

    - name: ğŸ” DEBUG - Print Python processes
      debug:
        var: python_procs.stdout_lines

    - name: ğŸ” DEBUG - Check if app is running on port 80
      shell: ss -tulpn | grep :8080 || true
      register: port_check

    - name: ğŸ” DEBUG - Show port 80 processes
      debug:
        var: port_check.stdout_lines

    - name: ğŸ” DEBUG - Tail Flask logs
      shell: tail -n 20 /var/log/flask.log || echo "log not found"
      register: flask_log

    - name: ğŸ” DEBUG - Show Flask logs
      debug:
        var: flask_log.stdout_lines

    - name: ğŸ” DEBUG - Check if Flask is installed
      shell: |
        source "{{ venv_dir }}/bin/activate"
        python -c "import flask; print('Flask is installed')"
      args:
        executable: /bin/bash

    - name: ğŸ” Show Flask service logs (from journalctl)
      shell: journalctl -u flask --no-pager -n 30 || cat /var/log/flask.log || echo "No logs found"
      register: flask_logs
      changed_when: false

    - name: ğŸ§¾ Print Flask logs
      debug:
        var: flask_logs.stdout_lines


####################