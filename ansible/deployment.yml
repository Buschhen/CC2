---
- name: Deploy Flask App to Azure VMs
  hosts: webservers
  become: yes

  vars:
    project_dir: /opt/cloud-docsearch
    repo_url: https://github.com/yourusername/cloud-docsearch.git  # replace with your repo
    venv_dir: "{{ project_dir }}/venv"

  tasks:
    - name: Install required apt packages
      apt:
        name: [git, python3-pip, python3-venv]
        state: present
        update_cache: yes

    - name: Clone project repo
      git:
        repo: "{{ repo_url }}"
        dest: "{{ project_dir }}"
        version: master
        force: yes

    - name: Create Python virtual environment
      command: python3 -m venv "{{ venv_dir }}"
      args:
        creates: "{{ venv_dir }}"

    - name: Install Python requirements
      pip:
        requirements: "{{ project_dir }}/requirements.txt"
        virtualenv: "{{ venv_dir }}"

    - name: Copy .env file (optional)
      copy:
        src: ../.env
        dest: "{{ project_dir }}/.env"
        mode: 0600

    - name: Start Flask app (simple background)
      shell: |
        nohup {{ venv_dir }}/bin/python {{ project_dir }}/app/main.py > /var/log/flask.log 2>&1 &
      args:
        executable: /bin/bash
